<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多功能PDF工具箱</title>
    <!-- 引入Tailwind CSS框架 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入jsPDF库 (用于图片转PDF) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- 引入pdf-lib库 (用于PDF合并) -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        /* --- 通用样式 --- */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 导航栏激活状态样式 */
        .tab-active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* blue-50 */
        }

        /* --- 图片转PDF工具特定样式 --- */
        #tool-image-to-pdf .preview-item {
            position: relative;
            cursor: move;
            transition: transform 0.2s ease-in-out;
        }
        #tool-image-to-pdf .preview-item .remove-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background-color: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            opacity: 1;
            transition: opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        #tool-image-to-pdf .dragging {
            opacity: 0.5;
            transform: scale(1.05);
        }
        #tool-image-to-pdf .drag-over {
            border-color: #3b82f6;
            transform: scale(1.02);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-6 md:p-8">
        
        <!-- === 导航栏 === -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                <button id="tab-image-to-pdf" class="tab-btn tab-active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                    图片转PDF
                </button>
                <button id="tab-pdf-merge" class="tab-btn text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg">
                    PDF合并
                </button>
            </nav>
        </div>

        <!-- === 工具容器 === -->
        <div id="tools-container">

            <!-- === 工具1: 图片转PDF (默认显示) === -->
            <div id="tool-image-to-pdf">
                <div class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">多图片合并转PDF</h1>
                    <p class="text-gray-500 mt-2">免费、快速、安全 - 所有转换均在您的浏览器本地完成</p>
                </div>
                <div id="drop-zone-img" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all duration-300 hover:border-blue-500 hover:bg-blue-50">
                    <input type="file" id="file-input-img" multiple accept="image/*" class="hidden">
                    <div class="flex flex-col items-center">
                        <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <p class="mt-4 text-lg text-gray-600">将图片拖拽到此处，或<span class="font-semibold text-blue-600">点击选择文件</span></p>
                        <p class="text-sm text-gray-500 mt-1">支持 JPG, PNG, WEBP, GIF 等格式</p>
                    </div>
                </div>
                <div class="mt-6 min-h-[120px]">
                    <div id="preview-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"></div>
                    <p id="placeholder-text-img" class="text-center text-gray-500 py-10">请先添加图片文件...</p>
                </div>
                <div id="action-area-img" class="mt-6 hidden">
                    <p class="text-sm text-gray-600 mb-4 text-center">提示：图片已按文件名自动排序，您仍可拖动调整</p>
                    <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                        <button id="convert-btn-img" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-12 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            <span id="btn-text-img">合并生成PDF</span>
                            <div id="loader-img" class="loader w-6 h-6 border-t-white border-4 hidden mx-auto"></div>
                        </button>
                        <button id="clear-btn-img" class="w-full md:w-auto bg-red-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-red-600 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                            一键清空
                        </button>
                    </div>
                </div>
            </div>

            <!-- === 工具2: PDF合并 (默认隐藏) === -->
            <div id="tool-pdf-merge" class="hidden">
                 <div class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">多发票合并到单页</h1>
                    <p class="text-gray-500 mt-2">将多个PDF文件（如发票）合并到一张A4纸上以便打印</p>
                </div>
                <div>
                     <label for="pdfFiles" class="block text-sm font-medium text-gray-700 mb-2">请选择需要合并的PDF发票文件：</label>
                     <input type="file" id="pdfFiles" multiple accept="application/pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6 border-t border-b py-6">
                    <div>
                        <label for="orientation" class="block text-sm font-medium text-gray-700">纸张方向:</label>
                        <select id="orientation" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <option value="portrait">纵向</option>
                            <option value="landscape">横向</option>
                        </select>
                    </div>
                    <div>
                        <label for="invoicesPerRow" class="block text-sm font-medium text-gray-700">每行发票数量:</label>
                        <input type="number" id="invoicesPerRow" value="2" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="invoicesPerCol" class="block text-sm font-medium text-gray-700">每列发票数量:</label>
                        <input type="number" id="invoicesPerCol" value="2" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                </div>
                <div class="flex flex-col md:flex-row justify-center items-center gap-4">
                    <button id="mergeBtn" class="w-full md:w-auto bg-blue-600 text-white font-bold py-3 px-12 rounded-lg shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 disabled:bg-gray-400">开始合并</button>
                    <button id="clearBtnPdf" class="w-full md:w-auto bg-red-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-red-600 transition-transform transform hover:scale-105">清除文件</button>
                    <button id="downloadBtn" class="w-full md:w-auto bg-green-500 text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-green-600 transition-transform transform hover:scale-105 hidden">下载PDF</button>
                </div>
                <div id="status" class="mt-4 text-center font-semibold text-gray-600"></div>
                <iframe id="pdfPreview" class="w-full h-[600px] mt-6 border border-gray-300 rounded-lg hidden"></iframe>
            </div>

        </div>
    </div>
    
    <!-- === 消息提示框 (通用) === -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg p-6 shadow-xl text-center max-w-sm w-full">
            <p id="modal-text" class="text-lg text-gray-700"></p>
            <button id="modal-close" class="mt-4 bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">好的</button>
        </div>
    </div>

    <script>
        // === 全局变量和初始化 ===
        const { jsPDF } = window.jspdf;
        const { PDFDocument } = window.PDFLib;

        // --- 获取通用DOM元素 ---
        const modal = document.getElementById('modal');
        const modalText = document.getElementById('modal-text');
        const modalClose = document.getElementById('modal-close');
        
        // --- 获取导航和工具容器 ---
        const tabImageToPdf = document.getElementById('tab-image-to-pdf');
        const tabPdfMerge = document.getElementById('tab-pdf-merge');
        const toolImageToPdf = document.getElementById('tool-image-to-pdf');
        const toolPdfMerge = document.getElementById('tool-pdf-merge');

        // --- 通用函数 ---
        function showModal(message) {
            modalText.textContent = message;
            modal.classList.remove('hidden');
        }
        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        // --- 导航切换逻辑 ---
        function switchTab(activeTab) {
            const tabs = [tabImageToPdf, tabPdfMerge];
            const tools = [toolImageToPdf, toolPdfMerge];
            
            tabs.forEach(tab => {
                tab.classList.remove('tab-active', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                if (tab === activeTab) {
                    tab.classList.add('tab-active');
                } else {
                    tab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                }
            });

            tools.forEach(tool => {
                // 根据激活的tab的ID来决定显示哪个工具
                const toolName = activeTab.id.replace('tab-', 'tool-');
                if (tool.id === toolName) {
                    tool.classList.remove('hidden');
                } else {
                    tool.classList.add('hidden');
                }
            });
        }
        tabImageToPdf.addEventListener('click', () => switchTab(tabImageToPdf));
        tabPdfMerge.addEventListener('click', () => switchTab(tabPdfMerge));

        
        // =============================================================================
        // === 工具1: 图片转PDF 的逻辑 (使用块作用域隔离变量) ===
        // =============================================================================
        {
            const dropZone = document.getElementById('drop-zone-img');
            const fileInput = document.getElementById('file-input-img');
            const previewGrid = document.getElementById('preview-grid');
            const placeholderText = document.getElementById('placeholder-text-img');
            const actionArea = document.getElementById('action-area-img');
            const convertBtn = document.getElementById('convert-btn-img');
            const btnText = document.getElementById('btn-text-img');
            const loader = document.getElementById('loader-img');
            const clearBtn = document.getElementById('clear-btn-img');

            let imageFiles = [];
            let dragSrcElement = null;

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-blue-500', 'bg-blue-50'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-blue-500', 'bg-blue-50'));
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('border-blue-500', 'bg-blue-50'); handleFiles(e.dataTransfer.files); });
            convertBtn.addEventListener('click', createPdf);
            clearBtn.addEventListener('click', clearAllImages);

            function clearAllImages() {
                imageFiles = [];
                renderPreview();
            }

            function handleFiles(files) {
                const newFiles = [...files].filter(file => file.type.startsWith('image/'));
                if (newFiles.length === 0) {
                    showModal('请选择图片文件！');
                    return;
                }
                imageFiles.push(...newFiles);
                imageFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' }));
                renderPreview();
            }

            function renderPreview() {
                previewGrid.innerHTML = '';
                placeholderText.classList.toggle('hidden', imageFiles.length > 0);
                actionArea.classList.toggle('hidden', imageFiles.length === 0);

                imageFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'preview-item w-full h-28 bg-gray-100 rounded-md overflow-hidden border-2 border-transparent';
                        previewItem.setAttribute('draggable', true);
                        previewItem.dataset.index = index;
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" class="w-full h-full object-cover">
                            <div class="remove-btn">&times;</div>
                        `;
                        previewGrid.appendChild(previewItem);
                        previewItem.querySelector('.remove-btn').addEventListener('click', (event) => {
                            event.stopPropagation();
                            removeImage(index);
                        });
                        addDragEvents(previewItem);
                    };
                    reader.readAsDataURL(file);
                });
            }

            function removeImage(index) {
                imageFiles.splice(index, 1);
                renderPreview();
            }

            function addDragEvents(item) {
                item.addEventListener('dragstart', (e) => {
                    dragSrcElement = item;
                    e.dataTransfer.effectAllowed = 'move';
                    item.classList.add('dragging');
                });
                item.addEventListener('dragenter', () => item.classList.add('drag-over'));
                item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
                item.addEventListener('dragover', (e) => { e.preventDefault(); return false; });
                item.addEventListener('drop', (e) => {
                    e.stopPropagation();
                    if (dragSrcElement !== item) {
                        const srcIndex = parseInt(dragSrcElement.dataset.index);
                        const targetIndex = parseInt(item.dataset.index);
                        const [removed] = imageFiles.splice(srcIndex, 1);
                        imageFiles.splice(targetIndex, 0, removed);
                        renderPreview();
                    }
                    item.classList.remove('drag-over');
                    return false;
                });
                item.addEventListener('dragend', () => {
                    item.classList.remove('dragging');
                    Array.from(previewGrid.children).forEach(child => child.classList.remove('drag-over'));
                });
            }

            async function createPdf() {
                if (imageFiles.length === 0) {
                    showModal('请先添加图片！');
                    return;
                }
                convertBtn.disabled = true;
                btnText.classList.add('hidden');
                loader.classList.remove('hidden');
                try {
                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const a4Width = 210, a4Height = 297, margin = 10;
                    const maxWidth = a4Width - margin * 2, maxHeight = a4Height - margin * 2;

                    for (let i = 0; i < imageFiles.length; i++) {
                        const imgData = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = e => resolve(e.target.result);
                            reader.readAsDataURL(imageFiles[i]);
                        });
                        const img = await new Promise(resolve => {
                           const image = new Image();
                           image.onload = () => resolve(image);
                           image.src = imgData;
                        });
                        
                        let pdfImgWidth = img.width, pdfImgHeight = img.height;
                        const ratio = img.width / img.height;
                        if (pdfImgWidth > maxWidth) { pdfImgWidth = maxWidth; pdfImgHeight = pdfImgWidth / ratio; }
                        if (pdfImgHeight > maxHeight) { pdfImgHeight = maxHeight; pdfImgWidth = pdfImgHeight * ratio; }
                        const x = (a4Width - pdfImgWidth) / 2, y = (a4Height - pdfImgHeight) / 2;
                        if (i > 0) doc.addPage();
                        doc.addImage(imgData, 'JPEG', x, y, pdfImgWidth, pdfImgHeight);
                    }
                    doc.save('合并的图片.pdf');
                } catch (error) {
                    console.error('PDF生成失败:', error);
                    showModal('生成PDF时发生错误，请检查控制台。');
                } finally {
                    convertBtn.disabled = false;
                    btnText.classList.remove('hidden');
                    loader.classList.add('hidden');
                }
            }
        }

        // =============================================================================
        // === 工具2: PDF合并 的逻辑 (使用块作用域隔离变量) ===
        // =============================================================================
        {
            const pdfFilesInput = document.getElementById('pdfFiles');
            const mergeBtn = document.getElementById('mergeBtn');
            const clearBtnPdf = document.getElementById('clearBtnPdf');
            const downloadBtn = document.getElementById('downloadBtn');
            const statusDiv = document.getElementById('status');
            const pdfPreview = document.getElementById('pdfPreview');

            let mergedPdfUrl = null;

            mergeBtn.addEventListener('click', handleMerge);
            clearBtnPdf.addEventListener('click', clearPdfFiles);
            downloadBtn.addEventListener('click', () => {
                if (mergedPdfUrl) {
                    const a = document.createElement('a');
                    a.href = mergedPdfUrl;
                    a.download = '合并的发票.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
            });
            
            pdfFilesInput.addEventListener('change', () => {
                if(pdfFilesInput.files.length > 0) {
                    mergeBtn.disabled = false;
                } else {
                    mergeBtn.disabled = true;
                }
            });

            function clearPdfFiles() {
                pdfFilesInput.value = ''; // 清空文件选择框
                statusDiv.textContent = '';
                pdfPreview.classList.add('hidden');
                downloadBtn.classList.add('hidden');
                mergeBtn.disabled = true;
                if (mergedPdfUrl) {
                    URL.revokeObjectURL(mergedPdfUrl); // 释放旧的URL占用的内存
                    mergedPdfUrl = null;
                }
            }

            async function handleMerge() {
                const files = pdfFilesInput.files;
                if (files.length === 0) {
                    showModal('请先选择PDF文件！');
                    return;
                }

                statusDiv.textContent = '正在合并，请稍候...';
                mergeBtn.disabled = true;
                downloadBtn.classList.add('hidden');
                pdfPreview.classList.add('hidden');

                try {
                    const orientation = document.getElementById('orientation').value;
                    const invoicesPerRow = parseInt(document.getElementById('invoicesPerRow').value) || 2;
                    const invoicesPerCol = parseInt(document.getElementById('invoicesPerCol').value) || 2;
                    
                    const a4Size = orientation === 'portrait' ? [595.28, 841.89] : [841.89, 595.28]; // A4 in points
                    const [pageWidth, pageHeight] = a4Size;

                    const mergedPdf = await PDFDocument.create();
                    let currentPage = null;
                    let invoiceCountOnPage = 0;
                    const invoicesPerPage = invoicesPerRow * invoicesPerCol;

                    const cellWidth = pageWidth / invoicesPerRow;
                    const cellHeight = pageHeight / invoicesPerCol;

                    for (let i = 0; i < files.length; i++) {
                        if (invoiceCountOnPage % invoicesPerPage === 0) {
                            currentPage = mergedPdf.addPage(a4Size);
                            invoiceCountOnPage = 0;
                        }

                        const pdfBytes = await files[i].arrayBuffer();
                        const invoicePdf = await PDFDocument.load(pdfBytes);
                        const [invoicePage] = await mergedPdf.embedPdf(invoicePdf);

                        const scale = Math.min(cellWidth / invoicePage.width, cellHeight / invoicePage.height) * 0.95; // 0.95 for padding
                        const scaledWidth = invoicePage.width * scale;
                        const scaledHeight = invoicePage.height * scale;

                        const col = invoiceCountOnPage % invoicesPerRow;
                        const row = Math.floor(invoiceCountOnPage / invoicesPerRow);

                        const x = col * cellWidth + (cellWidth - scaledWidth) / 2;
                        const y = pageHeight - (row + 1) * cellHeight + (cellHeight - scaledHeight) / 2;

                        currentPage.drawPage(invoicePage, {
                            x,
                            y,
                            width: scaledWidth,
                            height: scaledHeight,
                        });
                        
                        invoiceCountOnPage++;
                    }

                    const mergedPdfBytes = await mergedPdf.save();
                    const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });

                    if (mergedPdfUrl) {
                        URL.revokeObjectURL(mergedPdfUrl);
                    }
                    mergedPdfUrl = URL.createObjectURL(blob);

                    pdfPreview.src = mergedPdfUrl;
                    pdfPreview.classList.remove('hidden');
                    downloadBtn.classList.remove('hidden');
                    statusDiv.textContent = `合并成功！共 ${files.length} 个文件被合并。`;

                } catch (error) {
                    console.error('PDF合并失败:', error);
                    statusDiv.textContent = '合并失败，请检查文件或控制台信息。';
                    showModal('合并PDF时发生错误，可能是文件已损坏。');
                } finally {
                    mergeBtn.disabled = false;
                }
            }
        }
    </script>
</body>
</html>

